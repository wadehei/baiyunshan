<%@ page language="java" import="java.util.*" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="s" uri="/struts-tags" %>
<s:i18n name="i18n.hotelOrder_list">
<%
	String path = request.getContextPath();
	String basePath = request.getScheme() + "://"
			+ request.getServerName() + ":" + request.getServerPort()
			+ path + "/";
	request.setAttribute("appPath", path);
%>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head id="Head1">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title><s:text name="title" /></title>
<link rel="stylesheet" href="${appPath}/static/www/css/base.css" />
<link rel="stylesheet" href="${appPath}/static/www/css/order_list.css" />
<link rel="stylesheet" href="${appPath}/static/www/css/help.css" />
<link href="${appPath}/static/www/css/pagination.css" rel="stylesheet" />
<script type="text/javascript">
        //判断是否登录
        function loginValidate() {
        	var checkResult = true;
        	 $.ajax({
                 type: "post",
                 url: "${appPath}/hotelDetails/checklogin.do",
                 cache: false,
                 async: false,
                 data: {},
                 dataType: 'json',
                 success: function (result) {
                     if (result.code == -1) {
                    	 showLogin();
                         /* $('#divLogin').show(); */
                         checkResult = false;
                         return false;
                     }
                 },
                 error: function () {
                     alert('<s:text name="title" />'"网络连接错误，请检查");
                     checkResult = false;
                     return false;
                 }
             });
        	 return checkResult;
        }
    </script>
</head>
<!-- 头部 -->
<%@include file="bai-head.jsp"%>
<body style="background-color: #eee;" onload="loginValidate();">

	<script type="text/javascript">
//<![CDATA[
var theForm = document.forms['form1'];
if (!theForm) {
    theForm = document.form1;
}
function __doPostBack(eventTarget, eventArgument) {
    if (!theForm.onsubmit || (theForm.onsubmit() != false)) {
        theForm.__EVENTTARGET.value = eventTarget;
        theForm.__EVENTARGUMENT.value = eventArgument;
        theForm.submit();
    }
}
//]]>
</script>
	<!-- 头部 -->
	<script src="${appPath}/static/www/js/jquery-2.1.4.min.js"></script>
	<script src="${appPath}/static/www/js/common.js"></script>
	<style type="text/css">
.rewritenav li a {
	padding: 0 10px;
}
</style>

	<script type="text/javascript">
    //菜单选择
    var cUrl = location.href; //取得当前文件名
    cUrl = cUrl.toLowerCase(); //转换成小写
    var MenuFlag = new Array("", "resort/room", "resort/ticket", "resort/metting", "resort/gourmet", "resort/shop", "resort/help");
    // 将导航菜单中的页面文件名存入arr数组
    var flag = 0;
    for (var Menui = 0; Menui < 7; Menui++) {
        if (cUrl.indexOf(MenuFlag[Menui]) > 0) //判断当前页面是否存在数组中
        {
            document.getElementById("TopMenu" + Menui).className = "location";
            flag++;
        }
    }
    if (flag == 0) {
        document.getElementById("TopMenu0").className = "location";
    }
</script>
	<link rel="stylesheet" href="${appPath }/static/www/css/login.css" />

	<!---->
	<!--内容-->
	<div class="wrap">
		<div class="content" id="content">
			<div class="home_body_l clearfix">
				<ul class="pact-nav">
						<li >
                            <a href="${appPath}/personal/personalView.do"><s:text name="user_info" /></a>
                        </li>
                        <li>
                            <a href="${appPath}/personal/modifypwdView.do"><s:text name="update_password" /></a>
                        </li>
                        <li class="active">
                            <a href="${appPath }/webOrderList/queryWebOrderList.do"><s:text name="hotel_order" /></a>
                        </li>
                        <li>
                            <a href="${appPath }/webOrderList/queryTicketOrderNum.do"><s:text name="ticket_order" /></a>
                        </li>
				</ul>
			</div>
			<div class="home_body_r clearfix">
				<div class="pact_box pact_4">
					<h3><s:text name="hotel_order" /></h3>
					<ul class="record_hd">
						<li><s:text name="hotel_order_info" /></li>
						<li><s:text name="price" /></li>
						<li><s:text name="status" /></li>
						<li><s:text name="option" /></li>
					</ul>
					<!-- 外循环开始 -->
					<c:forEach items="${hotelOrderList }" var="o">
						<div style="margin-top: 20px; border: #d2d2d2 solid 1px;">
							<div class="re_list_hd">
								<span class="list_hd_date"><s:text name="order_time" />：${fn:substring(o.createDate,0,19) }</span> <span><s:text name="orderid" />：${o.orderID }</span>

							</div>
							<!-- 内循环开始 -->
							<c:forEach items="${o.hotelOrderItem }" var="i">
								<ul class="re_list_cont">
									<li>${i.typeName }*${i.roomCount }[${i.hotelName }]</li>
									<li>￥${i.salePrice }</li>
									<li>&nbsp;
										<div style="">
											<c:if test="${i.orderState==1||i.orderState==6 }">
												<c:if test="${i.isPay==0 }"><s:text name="status1" /></c:if>
												<c:if test="${i.isPay==1 }"><s:text name="status2" /></c:if>
											</c:if>
											<c:if test="${i.orderState==2 ||i.orderState==3}"><s:text name="status3" /></c:if>
											<c:if test="${i.orderState==4}"><s:text name="status4" /></c:if>
											<c:if test="${i.orderState==5}"><s:text name="status5" /></c:if>
										</div> 
										<a
										href="${appPath }/webOrderList/queryWebOrderItem.do?orderID=${o.orderID }"
										target="_blank"><s:text name="detail" /></a></li>
									<li><c:if
											test="${(i.orderState==1||i.orderState==6) && i.isPay==0}">
											<p>
												<button type="button" class="mergeBtn"
													onclick="checkRoomNumber('${o.orderID}')">
													<%--  onclick="location.href='${appPath}/hotelDetails/toPayPage.do?orderID=${o.orderID }'"> --%>
													<s:text name="pay" /> 
												</button>
											</p>
										</c:if> 
										<%-- <c:if test="${i.orderState==1 ||i.orderState==6}">
											<p>
												<a id="rptList_ctl00_lbtnCancel" class="btn"
													onclick="updateHotelOrderItem('${o.orderID}')">取消订单</a>
											</p>
										</c:if> --%>
										<%--  <c:if test="${i.canRefundCount>0 && i.isPay==1}">
											<button type="button" class="mergeBtn"
												onclick="location.href='${appPath }/webOrderList/queryWebOrderItem.do?orderID=${o.orderID }&flag=2'">我要退单</button>
										</c:if> --%></li>
								</ul>
							</c:forEach>
							<!--内循环结束  -->
						</div>
					</c:forEach>

				</div>
				<div class="pagelist"></div>
			</div>
		</div>
	</div>
	<!--end-->

	 <%@ include file="footer.jsp" %>
	<!---->
	<script type="text/javascript">
    (function () {
        var hm = document.createElement("script");
        hm.src = "http://v1.cnzz.com/stat.php?id=1262940786&web_id=1262940786";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
    
    function updateHotelOrderItem(orderID){
   		$.ajax({
   			type: "POST",
   			url: '<%=basePath%>webOrderList/updateHotelOrderItem.do',
   	    	data: {orderID:orderID,tm:new Date().getTime()},
   			dataType:'json',
   			cache: false,
   			success: function(data){
   				if(data.count==0){
   					alert('<s:text name="msg1" />' )
   				} else if(data.count==-1){
   					
   				}else {
   					alert('<s:text name="msg2" />')
   				}
   				location.reload();
   			}
   		});
    	
    }
    
    function checkRoomNumber(orderID){
    
    	$.ajax({
   			type: "POST",
   			url: '<%=basePath%>webOrderList/checkRoomNumber.do',
						data : {
							orderID : orderID
						},
						dataType : 'json',
						cache : false,
						success : function(data) {
							if (data.count == 0) {
								if (confirm('<s:text name="msg3" />' )) {
									updateHotelOrderItem(orderID);
								} else {
									return;
								}
							} else if (data.count == -1) {
								alert('<s:text name="msg4" />' );
							} else {

								location.href = '${appPath}/hotelDetails/toPayPage.do?orderID='
										+ orderID;
							}
						}
					});
		}
	</script>
</body>
</html>
</s:i18n>