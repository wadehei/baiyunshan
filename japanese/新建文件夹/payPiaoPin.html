<%@ page language="java" import="java.util.*" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%
String path = request.getContextPath();
String basePath = request.getScheme()+"://"+request.getServerName()+":"+request.getServerPort()+path+"/";
%>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>票务预定</title>
<meta name="keywords" content="洛阳白云山|河南白云山|洛阳白云山景区|嵩县白云山|白云山国家森林公园|白云山" />
<meta name="description" content="洛阳白云山景区唯一官方网站，为广大游客提供最新最详实的出行信息：交通指南、景区景点、食实住宿等，白云山国家森林公园欢迎您的到来。旅游热线：0379—66590158 66590004 66590127" />

<link rel="stylesheet" href="${appPath}/static/www/css/base.css">
<link rel="stylesheet" href="${appPath}/static/www/css/order.css">
<link rel="stylesheet" href="${appPath}/static/www/css/login.css">
<link rel="stylesheet" href="${appPath}/static/www/css/WdatePicker.css">

    <style>
        .rewritenav li a {
            padding: 0 10px;
        }
    </style>
</head>
<body>
<form name="form1" method="post" action="${appPath }/website/savePiaoPinOrder.do" id="form1">
<input hidden="hidden" name="tID" id="tID" value="${model.ticket.tID }">
   
    <!-- 头部 -->
    <%@include file="bai-head.jsp" %>
    <!-- 头部end -->
    
    <div id="divPay" style="display: none;">
    <div class="loginMask"></div>
    <div class="loginPop">
        <iframe id="payFrame" style="border: 0; width: 100%; height: 500px;"></iframe>
    </div>
</div>
    
    <!-- <==    Columns: orderID, tickeID, ticketName, ticketPrice, orderFrom, drpId, dtID, orderType, orderStatus, ticketCount, payAmt, realAmt, discountAmt, purchasePrice, payDate, checkCode, checkNum, checkFlag, buyUserID, buyName, buyMobile, buyIDCard, buyFingerprint, travelAgencyID, travelPeopelNum, payNum, payType, payStatus, refundNum, refundAmt, refundType, refundDate, remark, createDate, createUserID, expireTime, updateDate, updateUserID, isDelete, isSend, orgID, prepay_id, orderqrcode, drpName
<==        Row: 1521077660075552, 419e3aa306324ee781d9d128fc1cf452, 官网测试票品测试勿删, 150.00, 3, null, null, 2, 4, 3, 450.00, 450.00, 0.00, null, null, 249960, null, 0, , a, 15501520655, null, null, null, null, 1521077660075301, null, 0, null, 0.00, null, null, null, 2018-03-15 09:34:20.0, , null, null, null, 0, 0, , null, null, null
<==      Total: 1 -->
    <div class="wrap body">
            <div class="content" id="content">
                <div class="box-title">
                    <h3>支付信息</h3>
                </div>
                <div class="box-content">
                    <ul class="box-item">
                        <li><span>订单号</span>${model.order.orderID }</li>
                        <li><span>预订人</span>${model.order.buyName }(${model.order.buyMobile })</li>
                        <li><span>订单信息</span>${model.order.ticketName }*${model.order.ticketCount }</li>
                        <li><span>金额</span>¥${model.order.realAmt }元</li>
                    </ul>
                </div>
                <p class="text-right">本单需支付<span class="red">￥${model.order.realAmt }元</span></p>

                <div class="box-title">
                    <h3>第三方支付</h3>
                </div>

                <div class="box-content">
                    <p>订单提交成功请在10分钟内完成网上支付，超时订单将做无效处理。</p>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <label class="pay">
                        <input type="radio" name="payname" pid="4" checked="checked"><img src="${appPath }/static/www/images/alipay.jpg"></label>
                    <label class="pay">
                        <input type="radio" name="payname" pid="3"><img src="${appPath }/static/www/images/wxpay.jpg"></label>
                    <label class="pay" style="display: none;">
                        <input type="radio" name="payname"><img src="../../images/unionpay.jpg"></label>
                    <div class="text-center" style="margin-top: 30px;">
                        <input type="button" id="btnSubmit" value="确 定 支 付" onclick="submitPay(this);" class="redBtn">
                    </div>
                </div>
            </div>
        </div>
     <%@ include file="footer.jsp" %>
    <%-- <script type="text/javascript" src="${appPath}/static/www/js/jquery-1.8.3.min.js"></script> --%>
    <script type="text/javascript" src="${appPath}/static/www/js/common.js"></script>
    <script type="text/javascript" src="${appPath}/static/www/js/jquery.Spinner.js"></script>
    <script type="text/javascript" src="${appPath}/static/www/js/jquery.JPlaceholder.js"></script>
    <script type="text/javascript" src="${appPath}/static/www/js/WdatePicker.js"></script>
    
    <script type="text/javascript">
        (function () {
            var hm = document.createElement("script");
            hm.src = "http://v1.cnzz.com/stat.php?id=1262940786&web_id=1262940786";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
        
        function sumPrice() {
        	var tID = $("tID").val();
        	//var days = $(obj).val();
        	var txtNum = $("#txtNum").val();
        	var days = $("#txtTravelDate").val();
        	console.log(days);
        	var url = "${appPath}/website/toDangePiaopinJson.do";
        	$.post(url,{days:days,tID:tID,txtNum:txtNum},function(result){
        		var salePrice = result.ticket.salePrice;
        		var totalPrice = result.ticket.totalPrice;
        		if (salePrice == null || salePrice == "") {
					//没有为该日定义价格
        			$("#price").text("0.00");
        			$("#hidOrderAmt").val("0.00");
					alert("没有为"+days+"定义价格");
					nPrice();
				}else {
					$("#price").text(totalPrice);
					$("#hidOrderAmt").val(totalPrice);
					yPrice();
				}
        	});
        }
        
        function reduce_add_num(num) {
        	var txtNum = $("#txtNum").val();
        	var cNum = new Number(txtNum) + new Number(num);
        	if(cNum < 1) {
        	}else {
        		$("#txtNum").val(cNum);
        		sumPrice();
        	}
        }
        
        
        
        
     // 姓名校验
        function checkName(nameId) {
            var checkResult = true;
            var emptyReg = /^\s*(\S+\s*)+$/;
            if (emptyReg.test($("#" + nameId).val()) == false) {
                showError(nameId, '请输入姓名');
                checkResult = false;
                return;
            }
            if (checkResult) {
                hidError(nameId);
            }
            return checkResult;
        }

        // 手机号校验
        function checkMobile(phoneNumberId) {
            var checkResult = true;
            var emptyReg = /^\s*(\S+\s*)+$/;
            var reg = /^(1)\d{10}$/;
            if (emptyReg.test($("#" + phoneNumberId).val()) == false) {
                showError(phoneNumberId, '请输入手机号码');
                checkResult = false;
                return;
            } else {
                if (reg.test($("#" + phoneNumberId).val()) == false) {
                    showError(phoneNumberId, "手机号码格式不正确");
                    checkResult = false;
                    return;
                }
            }
            if (checkResult) {
                hidError(phoneNumberId);
            }
            return checkResult;
        }
        //提交前校验
        function submitOrder() {
            var checkResult = true;
            //姓名校验
            if (!checkName('txtReceiveName')) {
                checkResult = false;
                return false;
            }
            //手机号校验
            if (!checkMobile('txtReceiveMobile')) {
                checkResult = false;
                return false;
            }
            $.ajax({
                type: "post",
                url: "${appPath}/ajax/ajax.ashx?action=loginvalidate",
                cache: false,
                async: false,
                data: {},
                dataType: 'json',
                success: function (result) {
                    if (result.status == "n") {
                        $('#divLogin').show();
                        checkResult = false;
                        return false;
                    }
                },
                error: function () {
                    alert("网络连接错误，请检查");
                    checkResult = false;
                    return false;
                }
            });

            return checkResult;
        }

        //错误
        function showError(elementId, msg) {
            $("#" + elementId + "Msg").html(msg);
        }
        //正确
        function hidError(elementId) {
            $("#" + elementId + "Msg").html("*");
        }
    
        

        function submitPay(obj) {
            obj.value = '处理中...';
            obj.disabled = true;
            var pid = $("input[type='radio'][name='payname']:checked").attr("pid");
            $("input[type='radio'][name='payname']").attr("disabled", "disabled");

            $('#payFrame').attr("src", "${appPath}/website/qrPay.do?orderID=${model.order.orderID }&pid="+pid);
            $('#divPay').show();
        }
        
        
    </script>
</form>
</body>
</html>