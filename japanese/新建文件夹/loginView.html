<%@ page language="java" import="java.util.*" pageEncoding="utf-8"%>
<%@ taglib prefix="s" uri="/struts-tags" %>
<s:i18n name="i18n.loginView">
<%
String path = request.getContextPath();
String basePath = request.getScheme()+"://"+request.getServerName()+":"+request.getServerPort()+path+"/";
session.setAttribute("appPath", path);
%>
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
	<s:text name="user_login" />
</title>  
<base href="<%=basePath%>">
    <script src="${appPath}/static/www/js/jquery-1.8.3.min.js"></script>
    <script src="${appPath}/static/www/js/jquery.JPlaceholder.js"></script>
</head>
<body>
<%--    <form name="form1" method="post" action="./login.aspx" id="form1">--%>

        <link rel="stylesheet" href="${appPath}/static/www/css/login.css" />
        <div class="loginPop" style="top: 0px;">
            <div class="closePop">
                <img src="${appPath}/static/www/images/close.png" />
            </div>
            <h1><s:text name="user_login" /></h1>
            <div class="formBox">
                <div class="form-group">
                    <div class="input_group">
                        <input type="text" class="form_control" id="mobile" placeholder="<s:text name="mobile" />" onblur="checkMobile('mobile')" />
                    </div>
                    <div class="tip_msg" id="mobileMsg"></div>
                </div>
                <div class="form-group">
                    <div class="input_group">
                        <input type="password" class="form_control" id="pwd" placeholder="<s:text name="password" />" onblur="checkPWD('pwd')" />
                    </div>
                    <div class="tip_msg" id="pwdMsg"></div>
                </div>
                <div class="form-group clearfix">
                    <div class="input_group input_left">
                        <input type="text" class="form_control" id="img-captcha" placeholder="<s:text name="captcha" />" onblur="checkImgcode('img-captcha')" />
                    </div>
                    <div class="input_right pull_right yzm">
                        <img src="${appPath}/websiteLogin/code.do" onclick="ToggleCode(this, '${appPath}/websiteLogin/code.do');" />
                    </div>
                    <div class="tip_msg" id="img-captchaMsg"></div>
                </div>
                <div class="form-group" id="kk">
                    <button type="button" class="btn-default mt40" id="btnLogin" onclick="login();"><s:text name="login"/></button>
                </div>
            </div>
            <div class="fun-log">
                <a href="javacsript:;" class="forg forget"><s:text name="forget_password" /></a>
                <span class="txt"><s:text name="no_account" />？<a href="javacsript:;" class="register"><s:text name="registe" /></a></span>
            </div>
        </div>
        <script type="text/javascript" src="${appPath}/static/www/js/jquery-1.8.3.min.js"></script>

        <script type="text/javascript">
        	//打开忘记密码框
            $(".forget").click(function () {
                parent.showForget();
                parent.hideLogin();
            })
            //打开注册框
            $(".register").click(function () {
            	parent.showRegister();
            	parent.hideLogin();
            })
            //关闭登录框
            $(".closePop").click(function () {
            	parent.hideLogin();
            })
            // 手机号校验
            function checkMobile(phoneNumberId) {
                var checkResult = true;
                var emptyReg = /^\s*(\S+\s*)+$/;
                var reg = /^(1)\d{10}$/;
                if (emptyReg.test($("#" + phoneNumberId).val()) == false) {
                    showError(phoneNumberId, '<s:text name="msg1" />');
                    checkResult = false;
                    return;
                } else {
                    if (reg.test($("#" + phoneNumberId).val()) == false) {
                        showError(phoneNumberId, '<s:text name="msg2" />');
                        checkResult = false;
                        return;
                    }
                }
                if (checkResult) {
                    hidError(phoneNumberId);
                }
                return checkResult;
            }
            // 图形码校验
            function checkImgcode(captchaId) {
                var checkResult = true;
                var emptyReg = /^\s*(\S+\s*)+$/;
                var captcha = $("#" + captchaId).val();
                if (emptyReg.test(captcha) == false) {
                    showError(captchaId, '<s:text name="msg3" />');
                    checkResult = false;
                    return;
                } else {
                    $.ajax({
                        type: "post",
                        url: "${appPath}/websiteLogin/checkImgcode.do",
                        cache: false,
                        async: false,
                        data: { 'verification': captcha },
                        dataType: 'json',
                        success: function (data) {
                            if (data.result == "codeerror") {
                                showError(captchaId, '<s:text name="msg4" />');
                                checkResult = false;
                                return;
                            }
                        },
                        error: function () {
                            showError(captchaId, '<s:text name="msg5" />');
                            checkResult = false;
                            return;
                        }
                    });
                }
                if (checkResult) {
                    hidError(captchaId);
                }
                return checkResult;
            }
            //密码校验
            function checkPWD(pwdid) {
                var checkResult = true;
                var pwd = $("#" + pwdid).val();
                if (pwd == null || pwd == '') {
                    showError(pwdid, '<s:text name="msg6" />');
                    checkResult = false;
                    return;
                }
                if (checkResult) {
                    hidError(pwdid);
                }
                return checkResult;
            }
            //=============================切换验证码======================================
            function ToggleCode(obj, codeurl) {
                $(obj).attr("src", codeurl + "?time=" + Math.random());
            }

            //登录
            function login() {
                //手机号校验
                if (!checkMobile('mobile')) {
                    return;
                }
                //图形码校验
                if (!checkImgcode('img-captcha')) {
                    return;
                }
                //密码校验
                if (!checkPWD('pwd')) {
                    return;
                };
                var mobile = $("#mobile").val();
                var password = $("#pwd").val();
                var code = "yank1"+mobile+",llk,"+password+"yank2";
                $.ajax({
                    type: "post",
                    url: "${appPath}/websiteLogin/login.do",
                    cache: false,
                    async: false,
                    data: {KEYDATA:code},
                    dataType: 'json',
                    success: function (data) {
                        if (data.result == "success") {
                            alert('<s:text name="msg7" />');
                            parent.location.reload();
                        } else if(data.result=="usererror"){
                            alert('<s:text name="msg8" />');
                            return;
                        }
                    },
                    error: function () {
                        alert('<s:text name="msg5" />');
                        return;
                    }
                });
            }
            //错误
            function showError(elementId, msg) {
                $("#" + elementId + "Msg").html(msg);
            }
            //正确
            function hidError(elementId) {
                $("#" + elementId + "Msg").html("");
            }
        </script>
<%--    </form>--%>
</body>
</s:i18n>
</html>