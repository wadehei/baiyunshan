<%@ page language="java" import="java.util.*" pageEncoding="UTF-8"%>
<%@ taglib prefix="s" uri="/struts-tags" %>
<s:i18n name="i18n.forgetPassword">
<%
String path = request.getContextPath();
String basePath = request.getScheme()+"://"+request.getServerName()+":"+request.getServerPort()+path+"/";
session.setAttribute("appPath", path);
%>

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
	<s:text name="title" />
</title>
<base href="<%=basePath%>">
    <script src="${appPath}/static/www/js/jquery-1.8.3.min.js"></script>
    <script src="${appPath}/static/www/js/jquery.JPlaceholder.js"></script>
</head>
<body>
        <link rel="stylesheet" href="${appPath}/static/www/css/login.css" />
        <div class="loginPop" style="top: 0px;">
            <div class="closePop">
                <img src="${appPath}/static/www/images/close.png" />
            </div>
            <h1><s:text name="title" /></h1>
            <div class="formBox">
                <div class="form-group">
                    <div class="input_group">
                        <input type="text" class="form_control" id="mobile" placeholder="<s:text name="mobile" />" onblur="checkMobile('mobile');" />
                    </div>
                    <div class="tip_msg" id="mobileMsg"></div>
                </div>
                <div class="form-group clearfix">
                    <div class="input_group input_left">
                        <input type="text" class="form_control" id="img-captcha" onblur="checkImgcode('img-captcha')" placeholder="<s:text name="code" />" />
                    </div>
                    <div class="input_right pull_right yzm">
                        <img src="${appPath}/websiteLogin/code.do" onclick="ToggleCode(this, '${appPath}/websiteLogin/code.do');" />
                    </div>
                    <div class="tip_msg" id="img-captchaMsg"></div>
                </div>
                <div class="form-group clearfix">
                    <div class="input_group input_left">
                        <input type="text" class="form_control" id="captcha" placeholder="<s:text name="code" />" />
                    </div>
                    <div class="input_right pull_right">
                        <button type="button" class="btn-default" id="sendsms" onclick="sendSMS('mobile')"><s:text name="get_code" /></button>
                    </div>
                    <div class="tip_msg" id="captchaMsg"></div>
                </div>
                <div class="form-group">
                    <div class="input_group">
                        <input type="password" class="form_control" id="pwd" placeholder="<s:text name="password" />" />
                    </div>
                </div>
                <div class="form-group">
                    <div class="input_group">
                        <input type="password" class="form_control" id="repwd" placeholder="<s:text name="password2" />" />
                    </div>
                    <div class="tip_msg color_blue">
                        <span class="icon_sprite"></span>
                    </div>
                </div>
                <div class="form-group">
                    <button type="button" class="btn-default mt40" id="btnForget" onclick="forget();"><s:text name="sub" /></button>
                </div>
            </div>
        </div>
        <%-- <script type="text/javascript" src="${appPath}/static/www/js/jquery-1.8.3.min.js"></script> --%>
        <script type="text/javascript">
            //关闭忘记密码框
            $(".closePop").click(function () {
                parent.hideForget();
            })
            //发送短信
            function sendSMS(phoneNumberId) {
                //手机号校验
                if (!checkMobile('mobile')) {
                    $("#mobile").focus();
                    return;
                }
                if (!checkImgcode('img-captcha')) {
                    $("#img-captcha").focus();
                    return;
                }
                var mobile = $("#" + phoneNumberId).val();
                var vcode = $("#img-captcha").val();
                //发送短信
                $.ajax({
                    type: "post",
                    url: "${appPath}/websiteLogin/getPhoneCode.do",
                    cache: false,
                    data: { 'phone': mobile, 'verification': vcode },
                    dataType: "json",
                    success: function (result) {
                        var smsInput = $("#sendsms");
                        time(smsInput);
                    },
                    error: function () {
                        alert('<s:text name="msg1" />');
                        return;
                    }
                });
            }
            var wait = 60;
            function time(o) {
                if (wait == 0) {
                    o.attr("onclick", "sendSMS('mobile')");
                    o.removeClass("btn-gray").addClass("btn-default");
                    o.text('<s:text name="msg2" />');
                    wait = 60;
                } else {
                    o.removeAttr("onclick");
                    o.removeClass("btn-default").addClass("btn-gray");
                    o.text(wait + "S");
                    wait--;
                    setTimeout(function () {
                        time(o)
                    },
                    1000)
                }
            }
            // 短信验证码校验
            function checkSMScode(captchaId) {
                var checkResult = true;
                var emptyReg = /^\s*(\S+\s*)+$/;
                var reg = /\d{6}$/;
                var captcha = $("#" + captchaId).val();
                if (emptyReg.test(captcha) == false) {
                    alert('<s:text name="msg3" />');
                    checkResult = false;
                    return;
                } else {
                    if (reg.test(captcha) == false) {
                        alert('<s:text name="msg4" />' );
                        checkResult = false;
                        return;
                    }
                }
                return checkResult;
            }
            // 手机号校验 是否已经注册
            function checkMobile(phoneNumberId) {
                var checkResult = true;
                var emptyReg = /^\s*(\S+\s*)+$/;
                var reg = /^(1)\d{10}$/;
                if (emptyReg.test($("#" + phoneNumberId).val()) == false) {
                	showError(phoneNumberId,'<s:text name="msg5" />' );
                	$("#" + phoneNumberId).focus();
                    checkResult = false;
                    return;
                } else {
                    if (reg.test($("#" + phoneNumberId).val()) == false) {
                        showError(phoneNumberId,'<s:text name="msg6" />');
                        $("#" + phoneNumberId).focus();
                        checkResult = false;
                        return;
                    } else {
                        var mobile = $("#" + phoneNumberId).val();
                        $.ajax({
                            type: "post",
                            url: "${appPath}/websiteLogin/checkMobile.do",
                            cache: false,
                            async: false,
                            dataType: 'json',
                            data: { 'phone': mobile },
                            success: function (data) {
                                if (data.result == "phoneerror") {
                                    return;
                                }else{
                                	showError(phoneNumberId,'<s:text name="msg7" />' )
                                    $("#" + phoneNumberId).focus();
                                    checkResult = false;
                                    return;
                                }
                            },
                            error: function () {
                                alert('<s:text name="msg1" />' );
                                checkResult = false;
                                return;;
                            }
                        });
                    }
                }
                if (checkResult) {
                    hidError(phoneNumberId);
                }
                return checkResult;
            }
            // 图形码校验
            function checkImgcode(captchaId) {
                var checkResult = true;
                var emptyReg = /^\s*(\S+\s*)+$/;
                var captcha = $("#" + captchaId).val();
                if (emptyReg.test(captcha) == false) {
                	showError(captchaId,'<s:text name="msg8" />' );
                    checkResult = checkResult;
                    return;
                } else {
                	 $.ajax({
                         type: "post",
                         url: "${appPath}/websiteLogin/checkImgcode.do",
                         cache: false,
                         async: false,
                         data: { 'verification': captcha },
                         dataType: 'json',
                         success: function (data) {
                             if (data.result == "codeerror") {
                                 showError(captchaId,'<s:text name="msg9" />' );
                                 checkResult = false;
                                 return;
                             }
                         },
                         error: function () {
                             alert('<s:text name="msg1" />' );
                             checkResult = false;
                             return;
                         }
                     });
                }
                if (checkResult) {
                    hidError(captchaId);
                }
                return checkResult;
            }

            var weakPWD = ['000000', '111111', '11111111', '112233', '123123', '123321', '123456', '1234567', '12345678',
            '123456789', '1234567890', '654321', '666666', '888888', 'abcdef', 'abcabc', 'abc123', 'a1b2c3',
            'aaa111', '123qwe', 'qwe123', 'qwerty', 'qweasd', 'admin', 'password', 'p@ssword', 'passwd',
            'iloveyou', '5201314', 'password1', 'monkey', '', 'letmein', 'trustno1',
            'dragon', 'baseball', 'master', 'sunshine', 'shadow', 'superman', 'qazwsx', 'football', 'adobe123', 'admin123'];

            //密码校验
            function checkPWD(pwdid) {
                var checkResult = true;
                var pwd = $("#" + pwdid).val();
                if (pwd == null || pwd == '' || pwd.length < 6) {
                    alert('<s:text name="msg10" />' );
                    checkResult = false;
                    return;
                }
                for (i in weakPWD) {
                    if (pwd == weakPWD[i]) {
                        alert('<s:text name="msg10" />' );
                        checkResult = false;
                        return;
                    }
                }
                var reg = /^[a-zA-Z(~!@?#$%^&*()-=+_)0-9-_\\.]{6,16}$/;
                if (!reg.test(pwd)) {
                    alert('<s:text name="msg12" />' );
                    checkResult = false;
                    return;
                }
                var pwd = $("#pwd").val();
                var repwd = $("#repwd").val();
                if (pwd != repwd) {
                    alert('<s:text name="msg13" />' );
                    checkResult = false;
                    return;
                }
                return checkResult;
            }
            //=============================切换验证码======================================
            function ToggleCode(obj, codeurl) {
                $(obj).attr("src", codeurl + "?time=" + Math.random());
            }

            //找回密码
            function forget() {
                //手机号校验
                if (!checkMobile('mobile')) {
                    return;
                }
                // 短信验证码校验
                if (!checkSMScode('captcha')) {
                    return;
                }
                //图形码校验
                if (!checkImgcode('img-captcha')) {
                    return;
                }
                //密码校验
                if (!checkPWD('pwd')) {
                    return;
                };

                var code = "yank1"+$("#mobile").val()+",llk,"+$("#pwd").val()+"yank2,llk,"+$("#captcha").val();
                $.ajax({
                    type: "post",
                    url: "${appPath}/websiteLogin/forgetPassword.do",
                    cache: false,
                    async: false,
                    data: {KEYDATA:code,tm:new Date().getTime()},
                    dataType: 'json',
                    success: function (data) {
                        if (data.result == "nullphonecode") {
                            alert('<s:text name="msg14" />' );
                            return
                        } else if(data.result == "error"){
                            alert('<s:text name="msg15" />' );
                            return;
                        }else if(data.result == "phonecodeerror"){
                            alert('<s:text name="msg16" />' );
                            return;
                        }else if(data.result == "success"){
                        	alert('<s:text name="msg17" />' );
                            parent.location.reload();
                        }else if("pwderror"==data.result){
                        	alert('<s:text name="msg18" />' );
                            return;
                        }
                    },
                    error: function () {
                        alert('<s:text name="msg1" />');
                        return;
                    }
                });
            }
          //错误
            function showError(elementId, msg) {
                $("#" + elementId + "Msg").html(msg);
            }
            //正确
            function hidError(elementId) {
                $("#" + elementId + "Msg").html("");
            }
        </script>
</body>
</html>
</s:i18n>
