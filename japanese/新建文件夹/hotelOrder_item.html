<%@ page language="java" import="java.util.*" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%
	String path = request.getContextPath();
	String basePath = request.getScheme() + "://"
			+ request.getServerName() + ":" + request.getServerPort()
			+ path + "/";
	request.setAttribute("appPath", path);
%>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head id="Head1"><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
	详情 - 酒店订单
</title><link rel="stylesheet" href="${appPath}/static/www/css/base.css" />
<link rel="stylesheet" href="${appPath}/static/www/css/order_list.css" />
<link rel="stylesheet" href="${appPath}/static/www/css/help.css" />
<link href="${appPath}/static/www/css/pagination.css" rel="stylesheet" />
    <script type="text/javascript">
        //判断是否登录
        function loginValidate() {
        	var checkResult = true;
	       	 $.ajax({
	                type: "post",
	                url: "${appPath}/hotelDetails/checklogin.do",
	                cache: false,
	                async: false,
	                data: {},
	                dataType: 'json',
	                success: function (result) {
	                    if (result.code == -1) {
	                    	showLogin();
	                        /* $('#divLogin').show(); */
	                        checkResult = false;
	                        return false;
	                    }
	                },
	                error: function () {
	                    alert("网络连接错误，请检查");
	                    checkResult = false;
	                    return false;
	                }
	            });
	       	 return checkResult;
        }
    </script>
</head>
<%@include file="bai-head.jsp" %>
<body style="background-color: #eee;" onload="loginValidate();">

<script type="text/javascript">
//<![CDATA[
var theForm = document.forms['form1'];
if (!theForm) {
    theForm = document.form1;
}
function __doPostBack(eventTarget, eventArgument) {
    if (!theForm.onsubmit || (theForm.onsubmit() != false)) {
        theForm.__EVENTTARGET.value = eventTarget;
        theForm.__EVENTARGUMENT.value = eventArgument;
        theForm.submit();
    }
}
//]]>
</script>
<script src="${appPath}/static/www/js/jquery-2.1.4.min.js"></script>
<script src="${appPath}/static/www/js/common.js"></script>
<style type="text/css">
    .rewritenav li a {
        padding: 0 10px;
    }
    .re_list_hd li{
    	width: 22%;
    }
    .re_list_cont li{
    	width: 22%;
    }
</style>

<script type="text/javascript">
    //菜单选择
    var cUrl = location.href; //取得当前文件名
    cUrl = cUrl.toLowerCase(); //转换成小写
    var MenuFlag = new Array("", "resort/room", "resort/ticket", "resort/metting", "resort/gourmet", "resort/shop", "resort/help");
    // 将导航菜单中的页面文件名存入arr数组
    var flag = 0;
    for (var Menui = 0; Menui < 7; Menui++) {
        if (cUrl.indexOf(MenuFlag[Menui]) > 0) //判断当前页面是否存在数组中
        {
            document.getElementById("TopMenu" + Menui).className = "location";
            flag++;
        }
    }
    if (flag == 0) {
        document.getElementById("TopMenu0").className = "location";
    }
</script>
<link rel="stylesheet" href="${appPath }/static/www/css/login.css" />

        <!---->
        <!--内容-->
        <div class="wrap">
            <div class="content" id="content">
                <div class="record_list" style="margin-top: 20px;">

                    <div class="re_list_hd">
                        <ul>
                        	<c:if test="${pd.flag==2&&hotelItem.orderCnRefundCount>0 }">
                            <li style="width: 12%;">操作</li>
                            </c:if>
                            <li>房间信息</li>
                            <li>入住时间</li>
                            <li>离店时间</li>
                            <li>订单状态</li>
                        </ul>
                    </div>
                    <c:forEach items="${hotelRoomItemList }" var="r" varStatus="j">
                    	<div class="re_list_cont">
                            <ul>
                            	<c:if test="${pd.flag==2 &&hotelItem.orderCnRefundCount>0 }">
                            	<li style="width: 12%;">
                            		<label>
                            		<input type='checkbox' name='ids' value="${r.realAmt}" id="${r.itemID }" title="请选择要退款的房间" 
                            			<c:if test="${r.canRefundCount<=0 }">disabled="disabled"</c:if> class="ace"/>
                            		<span class="lbl"></span></label>
                            	</li>
                            	</c:if>
                                <li>${r.typeName }【
                                <c:if test="${r.orderType==1 }">现场入住</c:if>
                                <c:if test="${r.orderType==2 }">门市预订--散客</c:if>
                                <c:if test="${r.orderType==3 }">微信预订</c:if>
                                <c:if test="${r.orderType==4 }">门市预订--团队</c:if>
                                <c:if test="${r.orderType==5 }">网络-散客</c:if>】，
                                	<c:choose>
                                		<c:when test="${r.orderState==2}">已入住</c:when>
		                               	<c:when test="${r.orderState==3}">已离店</c:when>
		                               	<c:when test="${r.orderState==6}">排房</c:when>
		                               	<c:otherwise>未排房</c:otherwise>
                                	</c:choose>
                                </li>
                                <li>&nbsp;${fn:substring(r.checkInTime,0,10) }</li>
                                <li>&nbsp;${fn:substring(r.checkOutTime,0,10) }</li>
                                <li>&nbsp;
                                	<c:if test="${r.orderState==5}">已退款</c:if>
                                	<c:if test="${r.orderState==4}">已取消</c:if>
                                	<c:if test="${r.isPay==0&&r.orderState!=5 &&r.orderState!=4 }">未支付</c:if>
                                	<c:if test="${r.isPay==1&&r.orderState!=5 &&r.orderState!=4 }">已支付</c:if>
                                </li>
                            </ul>
                        </div>
                    
                    </c:forEach>
                    <c:if test="${pd.flag==2 &&hotelItem.orderCnRefundCount>0}">
                     <div class="re_list_cont">
                          <ul>
                              <li>应退款金额：
                                  <b><span style="color: #f60" id='spanRealPrice410'>￥0.00</span></b> 元
                                 <!--  <input type="hidden" id='hidRealPrice410' value="0.1" /> -->
                              </li>
                              <!-- <li>单张手续费：0 元</li> -->
                              <li>&nbsp;</li>
                              <li>&nbsp;</li>
                          </ul>
                    </div>
                        
                    <div class="re_list_cont">
                        <ul>
                            <li>
                                <input type="submit" name="btnSubmit" value="确 认 退 单" onclick="cancelOrderItem('${hotelItem.orderID }','${hotelItem.hotelID }')" class="redBtn" />
							</li>
                        </ul>
                    </div>
                    </c:if>
                        
                </div>
                <div class="re_list_dt">
                    <ul>
                        <li><span>下单时间：</span>${fn:substring(hotelItem.createDate,0,19) }</li>
                        <li><span>订单号：</span>${hotelItem.orderID }</li>
                        <li><span>订单信息：</span>
                        	${hotelItem.typeName }*${hotelItem.roomCount }[${hotelItem.hotelName }]</li>
                        <li><span>总金额：</span>￥${hotelItem.orderAmt }</li>
                        <li><span>预订人：</span>${hotelItem.gUserName }</li>
                        <li><span>手机号码：</span>${hotelItem.gMobile }</li>
                        
                    </ul>
                </div>
            </div>
        </div>
        <!--end-->
        
 <%@ include file="footer.jsp" %>
<!---->
<script src="${appPath}/static/js/myjs/BCMath.js"></script>
<script type="text/javascript">
    (function () {
        var hm = document.createElement("script");
        hm.src = "http://v1.cnzz.com/stat.php?id=1262940786&web_id=1262940786";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
    $("input[type=checkbox]").click(function(){
 		if($(this).find(".ace").is(':checked')){
 			$(this).find(".ace").removeAttr("checked");
 			makeAll();
 		}else{
 			$(this).find(".ace").prop("checked","true");
 			makeAll();
 		}
	})
  //批量操作
    function makeAll(){
    	var itemID = '';
    	var refundAmt = "0.00";
    	for(var i=0;i < document.getElementsByName('ids').length;i++){
    	  if(document.getElementsByName('ids')[i].checked){
    	  	if(itemID=='') itemID += "'"+document.getElementsByName('ids')[i].id+"'";
    	  	else itemID += ",'" + document.getElementsByName('ids')[i].id+"'";
    	  	
    	  	if(refundAmt=='') refundAmt += document.getElementsByName('ids')[i].value;
    	  	else refundAmt = accAdd(refundAmt,document.getElementsByName('ids')[i].value);
    	  }
    	}
    	$("#spanRealPrice410").text("￥"+refundAmt);
    }
    
    function cancelOrderItem(orderID,hotelID){
    	var itemID = "";
    	for(var i=0;i < document.getElementsByName('ids').length;i++){
    	  if(document.getElementsByName('ids')[i].checked){
    	  	if(itemID=='') itemID += "'"+document.getElementsByName('ids')[i].id+"'";
    	  	else itemID += ",'" + document.getElementsByName('ids')[i].id+"'";
    	  }
    	}
    	if(itemID==""){
    		alert("未选择要退款的订单项");
    	}else{
   			var valData={
    			orderID:orderID,
    			itemID:itemID,
    			itemTypes:0,
    			hotelID:hotelID
    			
    		};
   			$.ajax({
       		 	type: "POST",
           		url: '${appPath}/webOrderList/cancelHotelOrderItem.do',
               	data: valData,
           		dataType:'json',
           		cache: false,
           		async: false,
           		success: function(data){
           			alert(data.count);
                   if(data.count>0){
                	   alert("订单退款成功!");
                   } else if(data.count==-1){
   					
   				   }else{
   						alert("订单退款失败，请重新操作!");
                   }
                   location.reload();
           		}
       		});
    	}
    	 
    }
</script>
</body>
</html>

