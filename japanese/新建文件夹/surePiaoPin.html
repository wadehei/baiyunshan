<%@ page language="java" import="java.util.*" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%
String path = request.getContextPath();
String basePath = request.getScheme()+"://"+request.getServerName()+":"+request.getServerPort()+path+"/";
session.setAttribute("appPath", path);
%>



<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>票务预定</title>
<meta name="keywords" content="洛阳白云山|河南白云山|洛阳白云山景区|嵩县白云山|白云山国家森林公园|白云山" />
<meta name="description" content="洛阳白云山景区唯一官方网站，为广大游客提供最新最详实的出行信息：交通指南、景区景点、食实住宿等，白云山国家森林公园欢迎您的到来。旅游热线：0379—66590158 66590004 66590127" />

<link rel="stylesheet" href="${appPath}/static/www/css/base.css">
<link rel="stylesheet" href="${appPath}/static/www/css/order.css">
<link rel="stylesheet" href="${appPath}/static/www/css/login.css">
<link rel="stylesheet" href="${appPath}/static/www/css/WdatePicker.css">

    <style>
        .rewritenav li a {
            padding: 0 10px;
        }
    </style>
</head>
<body>
<form name="form1" method="post" action="${appPath}/website/savePiaoPinOrder.do" id="form1">
<input hidden="hidden" name="tID" id="tID" value="${model.ticket.tID }">
    <div>
    </div>
    <div>
    </div>
    <!-- 头部 -->
    <%@include file="bai-head.jsp" %>
    <!-- 头部end -->
    
    <div class="wrap">
            <div class="content" id="content">
                <div class="title">订单信息</div>
                <div class="box">
                    <ul>
                        <li><span>门票名称：</span>${model.ticket.ticketName }</li>
                        <li>
                            <span>游玩日期：</span>
                            <input name="txtTravelDate" type="text" id="txtTravelDate" class="dateico" onclick="WdatePicker({ readOnly: true, minDate: '%y-%M-%d', maxDate: '%y-%M-{%d+90}', onpicked: function () { sumPrice(); } })" value="${model.pd.days }" readonly="">
                        </li>
                        <li>
                            <span>门票数量：</span>
                            <div class="spinner">
                                <a href="javascript:;" onclick="reduce_add_num('-1')">－</a>
                                <input name="txtNum"  type="text" id="txtNum" minv="${model.ticket.minQuantity}"  totv='${model.ticket.stock}' maxv='${model.ticket.maxQuantity}' value="${model.pd.txtNum }" readonly="">
                                <a href="javascript:;" onclick="reduce_add_num('1')">＋</a>
                            </div>
                        </li>
                        <li class="ll">
                            <span>姓名：</span>
                            <input name="txtReceiveName"  type="text" id="txtReceiveName" onblur="checkName('txtReceiveName')" value="${model.pd.name }">
                            <label class="red" id="txtReceiveNameMsg">*</label>
                        </li>
                        <li class="ll">
                            <span>手机号码：</span>
                            <input name="txtReceiveMobile" type="text" id="txtReceiveMobile" onblur="checkMobile('txtReceiveMobile')" value="${model.pd.mobile }">
                            <label class="red" id="txtReceiveMobileMsg">*</label>
                        </li>
                        <li>
                            <span>总价：</span>
                            <input type="hidden" name="hidOrderAmt" id="hidOrderAmt" value="${model.ticket.totalPrice }">
                            <input type="hidden" name="salePrice" id="salePrice" value="${model.ticket.salePrice }">
                            <label id="price">${model.ticket.totalPrice }</label>
                            元
                            <div class="booking-notice" style="display: none;">
                                您选的时间<label id="errorMsg">库存不足</label>，请修改入住日期或返回重新下单。
                            </div>
                        </li>
                        <li class="buyBtn" style="display: list-item;">
                            <div class="right">
                                <input type="submit" name="btnSubmit" value="提交订单" onclick="return submitOrder();" id="btnSubmit" class="redBtn">
                                <button id="btnNoOrder" class="grayBtn" disabled="" type="button" style="display:none;">不可购买</button>
                            </div>
                        </li>
                    </ul>
                    <div class="booktips">
                        <span class="title">预定须知：</span>
<!--                         ①门票两日有效，出入园务必录入指纹，第二日入园需凭借指纹+昨日门票（景区开放时间内正门检票口）注意：1.只限于连续两天的游玩（隔天游玩不可使用）。2.指纹录入地址：景区入口检票处；<br>
②为保证取票、入园顺利，预订时请务必填写真实姓名、手机号码等信息。 -->
${model.ticket.ticketDes}
                    </div>
                    <div class="booktips">
                        <span class="title">温馨提示：</span>
                        ${model.ticket.tips}
<!--                         <p class="MsoNormal">
                            【发票说明】：
                        </p>
                        您需在游玩次日，在订单详情页中申请发票。
                        <p class="MsoNormal">
                            【退改说明】：
                        </p>
                        如需退款，可至订单详情页申请。<br>
(1)随时可申请退款，不支持部分退款。退款无需支付手续费。<br>
(2)本产品一经预订，不支持改期。 -->
                    </div>
                </div>
            </div>
        </div>
    
    
     <%@ include file="footer.jsp" %>
    <%-- <script type="text/javascript" src="${appPath}/static/www/js/jquery-1.8.3.min.js"></script> --%>
    <script type="text/javascript" src="${appPath}/static/www/js/common.js"></script>
    <script type="text/javascript" src="${appPath}/static/www/js/jquery.Spinner.js"></script>
    <script type="text/javascript" src="${appPath}/static/www/js/jquery.JPlaceholder.js"></script>
    <script type="text/javascript" src="${appPath}/static/www/js/WdatePicker.js"></script>
    
    <script type="text/javascript">
        
        function sumPrice() {
        	var tID = $("#tID").val();
        	//var days = $(obj).val();
        	var txtNum = $("#txtNum").val();
        	var days = $("#txtTravelDate").val();
        	console.log(days);
        	var url = "${appPath}/website/toDangePiaopinJson.do";
        	$.post(url,{days:days,tID:tID,txtNum:txtNum},function(result){
        		var salePrice = result.ticket.salePrice;
        		var totalPrice = result.ticket.totalPrice;
        		if (salePrice == null || salePrice == "") {
					//没有为该日定义价格
        			$("#price").text("0.00");
        			$("#hidOrderAmt").val("0.00");
					alert("没有为"+days+"定义价格");
					nPrice();
				}else {
					$("#price").text(totalPrice);
					$("#hidOrderAmt").val(totalPrice);
					yPrice();
				}
        	});
        }
        
        function reduce_add_num(num) {
        	var txtNum = $("#txtNum").val();
        	var minv = new Number($("#txtNum").attr("minv"));
        	var maxv = new Number($("#txtNum").attr("maxv"));
        	var totv = new Number($("#txtNum").attr("totv"));
        	var cNum = new Number(txtNum) + new Number(num);
        	if(cNum < minv) {
        	}else if(cNum > maxv){
        	}else if(cNum > totv){
        	}else {
        		$("#txtNum").val(cNum);
        		sumPrice();
        	}
        }
        
        
        
        
     // 姓名校验
        function checkName(nameId) {
            var checkResult = true;
            var emptyReg = /^\s*(\S+\s*)+$/;
            if (emptyReg.test($("#" + nameId).val()) == false) {
                showError(nameId, '请输入姓名');
                checkResult = false;
                return;
            }
            if (checkResult) {
                hidError(nameId);
            }
            return checkResult;
        }

        // 手机号校验
        function checkMobile(phoneNumberId) {
            var checkResult = true;
            var emptyReg = /^\s*(\S+\s*)+$/;
            var reg = /^(1)\d{10}$/;
            if (emptyReg.test($("#" + phoneNumberId).val()) == false) {
                showError(phoneNumberId, '请输入手机号码');
                checkResult = false;
                return;
            } else {
                if (reg.test($("#" + phoneNumberId).val()) == false) {
                    showError(phoneNumberId, "手机号码格式不正确");
                    checkResult = false;
                    return;
                }
            }
            if (checkResult) {
                hidError(phoneNumberId);
            }
            return checkResult;
        }
        //提交前校验
        function submitOrder() {
        	var tID=$("#tID").val();
        	var txtNum = $("#txtNum").val();
        	var txtTravelDate=$("#txtTravelDate").val();
        	var txtReceiveMobile=$("#txtReceiveMobile").val();
            var checkResult = true;
            //姓名校验
            if (!checkName('txtReceiveName')) {
                checkResult = false;
                return false;
            }
            //手机号校验
            if (!checkMobile('txtReceiveMobile')) {
                checkResult = false;
                return false;
            }
            $.ajax({
                type: "post",
                url: "${appPath}/hotelDetails/checklogin.do",
                cache: false,
                async: false,
                data: {},
                dataType: 'json',
                success: function (result) {
                    if (result.code == -1) {
                    	showLogin();
                        /* $('#divLogin').show(); */
                        checkResult = false;
                        return false;
                    }else{
                    	$.ajax({
                            type: "post",
                            url: "${appPath}/website/checkOrder.do",
                            cache: false,
                            async: false,
                            data: {tID:tID,txtNum:txtNum,txtTravelDate:txtTravelDate,txtReceiveMobile:txtReceiveMobile},
                            dataType: 'json',
                            success: function (result) {
                            	if(result.code==-1){
                            		alert(result.msg);
                            		checkResult = false;
                            		return false;
                            	}
                            }
                    	});
                    }
                },
                error: function () {
                    alert("网络连接错误，请检查");
                    checkResult = false;
                    return false;
                }
            });
            return checkResult;
        }

        //错误
        function showError(elementId, msg) {
            $("#" + elementId + "Msg").html(msg);
        }
        //正确
        function hidError(elementId) {
            $("#" + elementId + "Msg").html("*");
        }
    
        function nPrice() {
			$("#btnNoOrder").attr("style","display:");
			$("#btnSubmit").attr("style","display:none");
        }
        function yPrice() {
			$("#btnSubmit").attr("style","display:");
			$("#btnNoOrder").attr("style","display:none");
        }
        
    </script>
</form>
</body>
</html>